{% extends "base.html" %}
{% set page_version = "RIVET" %}

        
{% block prebody %}
<script type="text/javascript">
$(document).ready(function(){
    $('#add-parameter-point-btn').click(function(){
        $('#themodal').modal()
    })
    $('#request-id-modal').hide()
    $('#drophtml').hide()


    $('.process-btn').click(function(){
        parameter_pt = $(this).attr('data-parameter-pt')
        
        url = location.origin+'/rivet/processRequestPoint/{{request_info['requestId']}}/'+parameter_pt
        $.ajax(url,{
            complete: function(data){
                var jobguid = data['responseJSON']['jobguid']
                console.log(data['responseJSON'])

                console.log('got jobguid: '+jobguid)
                console.log('task ids of chain are: '+jobguid)
                //window.location.assign(location.origin+'/monitor/' + jobguid)
            }
        })
    })


    $('.result-btn').click(function(){
        var parameter_pt = $(this).attr('data-parameter-pt')
        window.location.assign(location.origin + '/rivetresult/result/{{request_info['requestId']}}/' + parameter_pt)
    })

    $('.result-btn').each(function(){
        var button = $(this)
        var parpoint = $(this).attr('data-parameter-pt')
        var resultsAvailable = false
        var url = location.origin+'/rivet/status/{{request_info['requestId']}}/'+parpoint
        console.log('checking result availability using ' + url)
        $.ajax(url,{
            async: false,
            complete: function(data){
                resultsAvailable = data['responseJSON']['resultsAvailable']
                if(!resultsAvailable){
                    button.addClass('disabled')
                }                    
            }
        })
    })

});
</script>

  
<div id="drophtml">
    <div class="dz-preview dz-file-preview">

        <div class="dz-progress progress">
            <div style="position:relative">
            <div class="dz-upload progress-bar" data-dz-uploadprogress style="position:absolute;height:25px">
            </div>
            <div class="dz-details" style="position:absolute;">
                <span class="dz-success-mark"><span class="glyphicon glyphicon-ok" aria-hidden="true"></span></span>
                <span class="dz-error-mark"><span class="glyphicon glyphicon-remove" aria-hidden="true"></span></span>
                <span class="dz-size" data-dz-size></span>
                <span class="dz-filename"><span data-dz-name style="display:inline-block;width:50%;white-space: nowrap;text-overflow:ellipsis;overflow:hidden;"></span></span>
            </div>                
            </div>
        </div>

    </div>
</div>

<script type="text/javascript">

var uploadguid = undefined;

Dropzone.options.dropzone = {

    // Prevents Dropzone from uploading dropped files immediately
    autoProcessQueue: false,
    previewTemplate: $("#drophtml").html(),
    dictDefaultMessage: '',  
    uploadMultiple: true,
    parallelUploads: 100,
    init: function() {
        var submitButton = document.querySelector("#create-point-btn")
        myDropzone = this; // closure
        submitButton.addEventListener("click", function() {
            myDropzone.processQueue(); // Tell Dropzone to process all queued files.
        });
        
        myDropzone.on('successmultiple',function(files,response){
            console.log(files)
            console.log(response)
            $('#themodal').modal('hide')
            location.reload();
        });
    }
};
</script>

{% endblock %}

{% block container%}
<div class="page-header">
    <h1>Rivet Request <small>{{request_info['title']}}</small></h1>
</div>    

<div class="row">
    <div class="col-md-12">
        <div class="panel panel-default">
        
            <div class="panel-heading">
                <h3 class="panel-title">Request Details</h3>
            </div>
            <div class="panel-body">
                <dl class="dl-horizontal">
                    {% for key,value in request_info.iteritems() %}
                        {% if key!= 'parameter-points' %}
                            <dt>{{key}}</dt>
                            <dd>{{value}}</dd>
                        {% endif %}
                    {% endfor %}
                </dl>        
            </div>

            <div class="panel-footer"></div>
        </div>
    </div> <!-- col -->
</div> <!-- row -->
<div class="row">
    <div class="col-md-12">
        <span>
            <p>
            <button id="add-parameter-point-btn"type="button" class="btn btn-default" aria-label="Left Align">
              <span class="glyphicon glyphicon-plus" aria-hidden="true"></span><span>Add Parameter Point</span>
            </button>    
            </p>
        </span>
    </div> <!-- col -->
</div> <!-- row -->

            
<div class="row">
    <div class="col-md-12">
        <div class="panel panel-default">

            <table id="parameter-points-table" class="table table-striped">
                <thead>
                    <tr>
                        <th>Parameter</th>
                        <th>Desciption</th>
                        <th>File</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for pinfo in param_info %}
                        <tr>
                            <td>{{pinfo['pointcount']}}</td>
                            <td>{{pinfo['description']}}</td>
                            <td>{{pinfo['file']}}</td>
                            <td>
                                <button data-parameter-pt="{{pinfo['pointcount']}}" class="btn btn-default process-btn">process</button>
                                <button data-parameter-pt="{{pinfo['pointcount']}}" class="btn btn-default result-btn">results</button>
                            </td>

                        </tr>
                    {% endfor %}
                </tbody>
            </table>
            <div class="panel-footer"></div>
        </div> <!-- panel -->
    </div> <!-- col -->
</div> <!-- row -->


<div id="themodal" class="modal fade">
  <div class="modal-dialog">
    <div class="modal-content">
    <div class="modal-body" style="overflow-y: auto;">
        <form action="/rivet/upload" method=post enctype=multipart/form-data class="dropzone" id="dropzone">
          <input value="{{request_info['requestId']}}" name="requestId" type="text" class="form-control" id="request-id-modal" placeholder="Request Id">

          <div class="form-group">
            <label for="title">User</label>
            <input value="lheinric" name="username" type="text" class="form-control" id="user-name" placeholder="username">
          </div>

          <div class="form-group">
            <label for="title">Point Description</label>
            <input value="" name="description" type="text" class="form-control" id="description" placeholder="description">
          </div>

          <p>Click to add files or drop on this area</p>            
          <div class="fallback" style="overflow-y: auto;">
              <input name="file" type="file" multiple />
              <input type="submit">submit</input>
          </div>
          </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="create-point-btn">Create Parameter Point</button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div id="upload-modal" class="modal fade">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
           <h4 class="modal-title">Success</h4>
      </div>
      <div class="modal-body">
          Uploaded latest result file to RECAST server.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-dismiss="modal">OK</button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->





{% endblock %}
